{"version":3,"file":"comint.esm.js","sources":["../src/index.js"],"sourcesContent":["const DEFAULTS = {\r\n    allowed_forums: [1, 2, 3],\r\n\r\n    // Acheminement des commentaires\r\n    // - \"per_post\" : un sujet de commentaires par RP (créé si absent)\r\n    // - \"single_topic\": tous les commentaires dans un seul sujet\r\n    mode: \"per_post\",\r\n\r\n    comments_forum_id: null,\r\n\r\n    single_topic_id: null,\r\n\r\n    // UI\r\n    use_overlay: true, // false => redirection vers l’éditeur natif\r\n    button_class: \"comint-btn\",\r\n    post_class: \"post\",\r\n\r\n    // Tagging\r\n    tag_on_create: {\r\n        in_title: true, // si false => ajouté en tête du message d’intro\r\n        format(topicId) {\r\n            return `#t${topicId}`;\r\n        },\r\n    },\r\n\r\n    // Titre du fil commentaires (mode per_topic)\r\n    comment_title_template(topic) {\r\n        const tag =\r\n            this.tag_on_create.enabled && this.tag_on_create.in_title\r\n                ? ` ${this.tag_on_create.format(topic.id)}`\r\n                : \"\";\r\n        return `${topic.title} • Commentaires${tag}`;\r\n    },\r\n\r\n    // Message d’intro du fil nouvellement créé\r\n    new_thread_intro(rpTopic) {\r\n        const tagLine =\r\n            this.tag_on_create.enabled && !this.tag_on_create.in_title\r\n                ? `${this.tag_on_create.format(rpTopic.id)}\\n\\n`\r\n                : \"\";\r\n        return (\r\n            `${tagLine}[b]Commentaires pour ce RP[/b]\\n` +\r\n            `RP : ${rpTopic.url}\\n\\n— Postez ici vos réactions aux messages, sans polluer le fil RP.`\r\n        );\r\n    },\r\n\r\n    // Mise en forme du message envoyé\r\n    build_payload({ permalink, op, body, quoted }) {\r\n        const header = quoted ? `[quote=${op}]${quoted}[/quote]\\n` : \"\";\r\n        return `${header}[url=${permalink}]→ Voir le message RP[/url]\\n\\n${body}`;\r\n    },\r\n\r\n    lang: navigator.language || \"fr\",\r\n};\r\n\r\n/**\r\n * I18N minimal.\r\n */\r\nconst I18N = {\r\n    fr: {\r\n        comment_button: \"Commenter\",\r\n        overlay_title: \"Commenter ce message\",\r\n        cancel: \"Annuler\",\r\n        send: \"Envoyer\",\r\n        missing_post_id: \"ID du message introuvable.\",\r\n        posted_toast: \"Commentaire publié !\",\r\n    },\r\n    en: {\r\n        comment_button: \"Comment\",\r\n        overlay_title: \"Comment on this post\",\r\n        cancel: \"Cancel\",\r\n        send: \"Send\",\r\n        missing_post_id: \"Post ID not found.\",\r\n        posted_toast: \"Comment posted!\",\r\n    },\r\n    es: {\r\n        comment_button: \"Comentar\",\r\n        overlay_title: \"Comentar en este mensaje\",\r\n        cancel: \"Cancelar\",\r\n        send: \"Enviar\",\r\n        missing_post_id: \"ID del mensaje no encontrado.\",\r\n        posted_toast: \"¡Comentario publicado!\",\r\n    },\r\n};\r\n\r\nlet currentLang = \"fr\";\r\n\r\nconst T = function (label) {\r\n    return (I18N[currentLang] && I18N[currentLang][label]) || label;\r\n};\r\n\r\nT.lang = function (lang) {\r\n    currentLang = lang;\r\n    return T;\r\n};\r\n\r\nconst getEnv = async () => {\r\n    return await Moderactor.env();\r\n};\r\n\r\nclass Comint {\r\n    constructor(options) {\r\n        if (!window.Moderactor)\r\n            throw new Error(\"Comint requires Moderactor to be loaded first.\");\r\n\r\n        this.config = { ...DEFAULTS, ...options };\r\n        this.currentPosts = new Map();\r\n        this.init();\r\n    }\r\n\r\n    async init() {\r\n        this.env = await getEnv();\r\n\r\n        if (this.env.page.type !== \"topic\") return;\r\n\r\n        console.log(this.env);\r\n\r\n        if (!this.config.comments_forum_id)\r\n            throw new Error(\"An ID is required in comments_forum_id.\");\r\n\r\n        if (this.config.allowed_forums.length === 0)\r\n            throw new Error(\"At least one ID is required in allowed_forums.\");\r\n\r\n        if (this.config.mode === \"single_topic\" && !this.config.single_topic_id)\r\n            throw new Error(\r\n                'Mode \"single_topic\" requires single_topic_id to be set.'\r\n            );\r\n\r\n        // init language\r\n        if (this.config.lang) T.lang(this.config.lang);\r\n\r\n        if (this.config.mode === \"per_post\") {\r\n            // est-ce que je devrais commencer à récupérer tous les topics de commentaires attachés aux posts présents sur la page?\r\n            // pre-fetch the comment topic for each post\r\n            document\r\n                .querySelectorAll(`.${this.config.post_class}`)\r\n                .forEach(async (post) => {\r\n                    await this.processPost(post);\r\n                });\r\n        }\r\n    }\r\n\r\n    consultCache(rpId) {\r\n        /*\r\n        doit chercher dans local_storage si un rp_id est associé à un comment_id\r\n         */\r\n    }\r\n\r\n    async processPost(post) {\r\n        const idAttr = post.getAttribute(\"id\").match(/^p?(\\d+)$/) || \"\";\r\n        console.log(idAttr[1]);\r\n    }\r\n}\r\n\r\nexport default Comint;\r\n"],"names":[],"mappings":"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"}