{"version":3,"file":"comint.js","sources":["../src/index.js"],"sourcesContent":["const DEFAULTS = {\r\n    allowed_forums: [1, 2, 3],\r\n\r\n    // Acheminement des commentaires\r\n    // - \"per_post\" : un sujet de commentaires par RP (créé si absent)\r\n    // - \"single_topic\": tous les commentaires dans un seul sujet\r\n    mode: \"per_post\",\r\n\r\n    comments_forum_id: null,\r\n\r\n    single_topic_id: null,\r\n\r\n    // UI\r\n    use_overlay: true, // false => redirection vers l’éditeur natif\r\n    button_class: \"comint-btn\",\r\n    post_class: \"post\",\r\n\r\n    // Tagging\r\n    tag_on_create: {\r\n        in_title: true, // si false => ajouté en tête du message d’intro\r\n        format(topicId) {\r\n            return `#t${topicId}`;\r\n        },\r\n    },\r\n\r\n    // Titre du fil commentaires (mode per_topic)\r\n    comment_title_template(topic) {\r\n        const tag =\r\n            this.tag_on_create.enabled && this.tag_on_create.in_title\r\n                ? ` ${this.tag_on_create.format(topic.id)}`\r\n                : \"\";\r\n        return `${topic.title} • Commentaires${tag}`;\r\n    },\r\n\r\n    // Message d’intro du fil nouvellement créé\r\n    new_thread_intro(rpTopic) {\r\n        const tagLine =\r\n            this.tag_on_create.enabled && !this.tag_on_create.in_title\r\n                ? `${this.tag_on_create.format(rpTopic.id)}\\n\\n`\r\n                : \"\";\r\n        return (\r\n            `${tagLine}[b]Commentaires pour ce RP[/b]\\n` +\r\n            `RP : ${rpTopic.url}\\n\\n— Postez ici vos réactions aux messages, sans polluer le fil RP.`\r\n        );\r\n    },\r\n\r\n    // Mise en forme du message envoyé\r\n    build_payload({ permalink, op, body, quoted }) {\r\n        const header = quoted ? `[quote=${op}]${quoted}[/quote]\\n` : \"\";\r\n        return `${header}[url=${permalink}]→ Voir le message RP[/url]\\n\\n${body}`;\r\n    },\r\n\r\n    lang: navigator.language || \"fr\",\r\n};\r\n\r\n/**\r\n * I18N minimal.\r\n */\r\nconst I18N = {\r\n    fr: {\r\n        comment_button: \"Commenter\",\r\n        overlay_title: \"Commenter ce message\",\r\n        cancel: \"Annuler\",\r\n        send: \"Envoyer\",\r\n        missing_post_id: \"ID du message introuvable.\",\r\n        posted_toast: \"Commentaire publié !\",\r\n    },\r\n    en: {\r\n        comment_button: \"Comment\",\r\n        overlay_title: \"Comment on this post\",\r\n        cancel: \"Cancel\",\r\n        send: \"Send\",\r\n        missing_post_id: \"Post ID not found.\",\r\n        posted_toast: \"Comment posted!\",\r\n    },\r\n    es: {\r\n        comment_button: \"Comentar\",\r\n        overlay_title: \"Comentar en este mensaje\",\r\n        cancel: \"Cancelar\",\r\n        send: \"Enviar\",\r\n        missing_post_id: \"ID del mensaje no encontrado.\",\r\n        posted_toast: \"¡Comentario publicado!\",\r\n    },\r\n};\r\n\r\nlet currentLang = \"fr\";\r\n\r\nconst T = function (label) {\r\n    return (I18N[currentLang] && I18N[currentLang][label]) || label;\r\n};\r\n\r\nT.lang = function (lang) {\r\n    currentLang = lang;\r\n    return T;\r\n};\r\n\r\nconst getEnv = async () => {\r\n    return await Moderactor.env();\r\n};\r\n\r\nclass Comint {\r\n    constructor(options) {\r\n        if (!window.Moderactor)\r\n            throw new Error(\"Comint requires Moderactor to be loaded first.\");\r\n\r\n        this.config = { ...DEFAULTS, ...options };\r\n        this.currentPosts = new Map();\r\n        this.init();\r\n    }\r\n\r\n    async init() {\r\n        this.env = await getEnv();\r\n\r\n        if (this.env.page.type !== \"topic\") return;\r\n\r\n        console.log(this.env);\r\n\r\n        if (!this.config.comments_forum_id)\r\n            throw new Error(\"An ID is required in comments_forum_id.\");\r\n\r\n        if (this.config.allowed_forums.length === 0)\r\n            throw new Error(\"At least one ID is required in allowed_forums.\");\r\n\r\n        if (this.config.mode === \"single_topic\" && !this.config.single_topic_id)\r\n            throw new Error(\r\n                'Mode \"single_topic\" requires single_topic_id to be set.'\r\n            );\r\n\r\n        // init language\r\n        if (this.config.lang) T.lang(this.config.lang);\r\n\r\n        if (this.config.mode === \"per_post\") {\r\n            // est-ce que je devrais commencer à récupérer tous les topics de commentaires attachés aux posts présents sur la page?\r\n            // pre-fetch the comment topic for each post\r\n            document\r\n                .querySelectorAll(`.${this.config.post_class}`)\r\n                .forEach(async (post) => {\r\n                    await this.processPost(post);\r\n                });\r\n        }\r\n    }\r\n\r\n    consultCache(rpId) {\r\n        /*\r\n        doit chercher dans local_storage si un rp_id est associé à un comment_id\r\n         */\r\n    }\r\n\r\n    async processPost(post) {\r\n        const idAttr = post.getAttribute(\"id\").match(/^p?(\\d+)$/) || \"\";\r\n        console.log(idAttr[1]);\r\n    }\r\n}\r\n\r\nexport default Comint;\r\n"],"names":[],"mappings":";;;IAAA,MAAM,QAAQ,GAAG;IACjB,IAAI,cAAc,EAAE,CAAC,CAAC,EAAE,CAAC,EAAE,CAAC,CAAC;AAC7B;IACA;IACA;IACA;IACA,IAAI,IAAI,EAAE,UAAU;AACpB;IACA,IAAI,iBAAiB,EAAE,IAAI;AAC3B;IACA,IAAI,eAAe,EAAE,IAAI;AACzB;IACA;IACA,IAAI,WAAW,EAAE,IAAI;IACrB,IAAI,YAAY,EAAE,YAAY;IAC9B,IAAI,UAAU,EAAE,MAAM;AACtB;IACA;IACA,IAAI,aAAa,EAAE;IACnB,QAAQ,QAAQ,EAAE,IAAI;IACtB,QAAQ,MAAM,CAAC,OAAO,EAAE;IACxB,YAAY,OAAO,CAAC,EAAE,EAAE,OAAO,CAAC,CAAC,CAAC;IAClC,QAAQ,CAAC;IACT,KAAK;AACL;IACA;IACA,IAAI,sBAAsB,CAAC,KAAK,EAAE;IAClC,QAAQ,MAAM,GAAG;IACjB,YAAY,IAAI,CAAC,aAAa,CAAC,OAAO,IAAI,IAAI,CAAC,aAAa,CAAC,QAAQ;IACrE,kBAAkB,CAAC,CAAC,EAAE,IAAI,CAAC,aAAa,CAAC,MAAM,CAAC,KAAK,CAAC,EAAE,CAAC,CAAC,CAAC;IAC3D,kBAAkB,EAAE,CAAC;IACrB,QAAQ,OAAO,CAAC,EAAE,KAAK,CAAC,KAAK,CAAC,eAAe,EAAE,GAAG,CAAC,CAAC,CAAC;IACrD,IAAI,CAAC;AACL;IACA;IACA,IAAI,gBAAgB,CAAC,OAAO,EAAE;IAC9B,QAAQ,MAAM,OAAO;IACrB,YAAY,IAAI,CAAC,aAAa,CAAC,OAAO,IAAI,CAAC,IAAI,CAAC,aAAa,CAAC,QAAQ;IACtE,kBAAkB,CAAC,EAAE,IAAI,CAAC,aAAa,CAAC,MAAM,CAAC,OAAO,CAAC,EAAE,CAAC,CAAC,IAAI,CAAC;IAChE,kBAAkB,EAAE,CAAC;IACrB,QAAQ;IACR,YAAY,CAAC,EAAE,OAAO,CAAC,gCAAgC,CAAC;IACxD,YAAY,CAAC,KAAK,EAAE,OAAO,CAAC,GAAG,CAAC,oEAAoE,CAAC;IACrG,UAAU;IACV,IAAI,CAAC;AACL;IACA;IACA,IAAI,aAAa,CAAC,EAAE,SAAS,EAAE,EAAE,EAAE,IAAI,EAAE,MAAM,EAAE,EAAE;IACnD,QAAQ,MAAM,MAAM,GAAG,MAAM,GAAG,CAAC,OAAO,EAAE,EAAE,CAAC,CAAC,EAAE,MAAM,CAAC,UAAU,CAAC,GAAG,EAAE,CAAC;IACxE,QAAQ,OAAO,CAAC,EAAE,MAAM,CAAC,KAAK,EAAE,SAAS,CAAC,+BAA+B,EAAE,IAAI,CAAC,CAAC,CAAC;IAClF,IAAI,CAAC;AACL;IACA,IAAI,IAAI,EAAE,SAAS,CAAC,QAAQ,IAAI,IAAI;IACpC,CAAC,CAAC;AACF;IACA;IACA;IACA;IACA,MAAM,IAAI,GAAG;IACb,IAAI,EAAE,EAAE;IACR,QAAQ,cAAc,EAAE,WAAW;IACnC,QAAQ,aAAa,EAAE,sBAAsB;IAC7C,QAAQ,MAAM,EAAE,SAAS;IACzB,QAAQ,IAAI,EAAE,SAAS;IACvB,QAAQ,eAAe,EAAE,4BAA4B;IACrD,QAAQ,YAAY,EAAE,sBAAsB;IAC5C,KAAK;IACL,IAAI,EAAE,EAAE;IACR,QAAQ,cAAc,EAAE,SAAS;IACjC,QAAQ,aAAa,EAAE,sBAAsB;IAC7C,QAAQ,MAAM,EAAE,QAAQ;IACxB,QAAQ,IAAI,EAAE,MAAM;IACpB,QAAQ,eAAe,EAAE,oBAAoB;IAC7C,QAAQ,YAAY,EAAE,iBAAiB;IACvC,KAAK;IACL,IAAI,EAAE,EAAE;IACR,QAAQ,cAAc,EAAE,UAAU;IAClC,QAAQ,aAAa,EAAE,0BAA0B;IACjD,QAAQ,MAAM,EAAE,UAAU;IAC1B,QAAQ,IAAI,EAAE,QAAQ;IACtB,QAAQ,eAAe,EAAE,+BAA+B;IACxD,QAAQ,YAAY,EAAE,wBAAwB;IAC9C,KAAK;IACL,CAAC,CAAC;AACF;IACA,IAAI,WAAW,GAAG,IAAI,CAAC;AACvB;IACA,MAAM,CAAC,GAAG,UAAU,KAAK,EAAE;IAC3B,IAAI,OAAO,CAAC,IAAI,CAAC,WAAW,CAAC,IAAI,IAAI,CAAC,WAAW,CAAC,CAAC,KAAK,CAAC,KAAK,KAAK,CAAC;IACpE,CAAC,CAAC;AACF;IACA,CAAC,CAAC,IAAI,GAAG,UAAU,IAAI,EAAE;IACzB,IAAI,WAAW,GAAG,IAAI,CAAC;IACvB,IAAI,OAAO,CAAC,CAAC;IACb,CAAC,CAAC;AACF;IACA,MAAM,MAAM,GAAG,YAAY;IAC3B,IAAI,OAAO,MAAM,UAAU,CAAC,GAAG,EAAE,CAAC;IAClC,CAAC,CAAC;AACF;IACA,MAAM,MAAM,CAAC;IACb,IAAI,WAAW,CAAC,OAAO,EAAE;IACzB,QAAQ,IAAI,CAAC,MAAM,CAAC,UAAU;IAC9B,YAAY,MAAM,IAAI,KAAK,CAAC,gDAAgD,CAAC,CAAC;AAC9E;IACA,QAAQ,IAAI,CAAC,MAAM,GAAG,EAAE,GAAG,QAAQ,EAAE,GAAG,OAAO,EAAE,CAAC;IAClD,QAAQ,IAAI,CAAC,YAAY,GAAG,IAAI,GAAG,EAAE,CAAC;IACtC,QAAQ,IAAI,CAAC,IAAI,EAAE,CAAC;IACpB,IAAI,CAAC;AACL;IACA,IAAI,MAAM,IAAI,GAAG;IACjB,QAAQ,IAAI,CAAC,GAAG,GAAG,MAAM,MAAM,EAAE,CAAC;AAClC;IACA,QAAQ,IAAI,IAAI,CAAC,GAAG,CAAC,IAAI,CAAC,IAAI,KAAK,OAAO,EAAE,OAAO;AACnD;IACA,QAAQ,OAAO,CAAC,GAAG,CAAC,IAAI,CAAC,GAAG,CAAC,CAAC;AAC9B;IACA,QAAQ,IAAI,CAAC,IAAI,CAAC,MAAM,CAAC,iBAAiB;IAC1C,YAAY,MAAM,IAAI,KAAK,CAAC,yCAAyC,CAAC,CAAC;AACvE;IACA,QAAQ,IAAI,IAAI,CAAC,MAAM,CAAC,cAAc,CAAC,MAAM,KAAK,CAAC;IACnD,YAAY,MAAM,IAAI,KAAK,CAAC,gDAAgD,CAAC,CAAC;AAC9E;IACA,QAAQ,IAAI,IAAI,CAAC,MAAM,CAAC,IAAI,KAAK,cAAc,IAAI,CAAC,IAAI,CAAC,MAAM,CAAC,eAAe;IAC/E,YAAY,MAAM,IAAI,KAAK;IAC3B,gBAAgB,yDAAyD;IACzE,aAAa,CAAC;AACd;IACA;IACA,QAAQ,IAAI,IAAI,CAAC,MAAM,CAAC,IAAI,EAAE,CAAC,CAAC,IAAI,CAAC,IAAI,CAAC,MAAM,CAAC,IAAI,CAAC,CAAC;AACvD;IACA,QAAQ,IAAI,IAAI,CAAC,MAAM,CAAC,IAAI,KAAK,UAAU,EAAE;IAC7C;IACA;IACA,YAAY,QAAQ;IACpB,iBAAiB,gBAAgB,CAAC,CAAC,CAAC,EAAE,IAAI,CAAC,MAAM,CAAC,UAAU,CAAC,CAAC,CAAC;IAC/D,iBAAiB,OAAO,CAAC,OAAO,IAAI,KAAK;IACzC,oBAAoB,MAAM,IAAI,CAAC,WAAW,CAAC,IAAI,CAAC,CAAC;IACjD,gBAAgB,CAAC,CAAC,CAAC;IACnB,QAAQ,CAAC;IACT,IAAI,CAAC;AACL;IACA,IAAI,YAAY,CAAC,IAAI,EAAE;IACvB;IACA;IACA;IACA,IAAI,CAAC;AACL;IACA,IAAI,MAAM,WAAW,CAAC,IAAI,EAAE;IAC5B,QAAQ,MAAM,MAAM,GAAG,IAAI,CAAC,YAAY,CAAC,IAAI,CAAC,CAAC,KAAK,CAAC,WAAW,CAAC,IAAI,EAAE,CAAC;IACxE,QAAQ,OAAO,CAAC,GAAG,CAAC,MAAM,CAAC,CAAC,CAAC,CAAC,CAAC;IAC/B,IAAI,CAAC;IACL;;;;;;;;"}